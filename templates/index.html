<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtrader Flask App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        .form-group input[type="number"],
        .form-group input[type="file"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .form-group input[type="number"]:focus,
        .form-group input[type="file"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .submit-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: none;
            width: auto;
            display: inline-block;
        }
        .submit-button:hover {
            background-color: #2563eb;
        }
        .results-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        .results-section h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .results-section p {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            color: #4b5563;
        }
        .results-section p strong {
            color: #1f2937;
        }
        .error-message {
            color: #dc2626;
            background-color: #fee2e2;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            border: 1px solid #ef4444;
        }
        .success-message {
            color: #16a34a;
            background-color: #dcfce7;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            border: 1px solid #22c55e;
        }
        .chart-container {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .strategy-params {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            transition: opacity 0.3s ease;
        }
        .hidden {
            display: none;
        }
        @media (max-width: 640px) {
            .container {
                padding: 1.5rem;
            }
            .form-group {
                margin-bottom: 1rem;
            }
            .form-group label {
                margin-bottom: 0.25rem;
            }
            .form-group input[type="number"],
            .form-group input[type="file"],
            .form-group select {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            .submit-button {
                padding: 0.6rem 1.2rem;
                font-size: 1rem;
                width: 100%;
            }
            .results-section h2 {
                font-size: 1.5rem;
            }
            .results-section p {
                font-size: 1rem;
            }
            .strategy-params {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Backtrader Flask Application</h1>
        <p class="text-center text-gray-600 mb-8">Upload historical stock or futures data (CSV), select a trading strategy, and run a backtest.</p>

        <form action="/run_backtest" method="post" enctype="multipart/form-data" class="space-y-6">
            <div class="form-group">
                <label for="data_file" class="block text-sm font-medium text-gray-700">Upload CSV Data:</label>
                <input type="file" name="data_file" id="data_file" accept=".csv" required
                       class="mt-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none focus:border-blue-500">
                <p class="mt-1 text-xs text-gray-500">
                    Expected CSV columns (case-sensitive): <strong>Date, Open, High, Low, Close, Volume, OpenInterest</strong>.
                    OpenInterest is optional. Ensure 'Date' column is in a parseable format (e.g., YYYY-MM-DD).
                </p>
            </div>

            <div class="form-group">
                <label for="strategy" class="block text-sm font-medium text-gray-700">Trading Strategy:</label>
                <select name="strategy" id="strategy" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    <option value="sma_crossover">SMA Crossover</option>
                    <option value="ema_crossover">EMA Crossover</option>
                    <option value="rsi">RSI Mean Reversion</option>
                    <option value="bollinger_bands">Bollinger Bands Breakout</option>
                    <option value="macd">MACD Crossover</option>
                    <option value="breakout">Price Channel Breakout</option>
                </select>
            </div>

            <div id="params-sma_crossover" class="strategy-params">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label for="sma_fast_period" class="block text-sm font-medium text-gray-700">Fast SMA Period:</label>
                        <input type="number" name="sma_fast_period" id="sma_fast_period" value="10" min="1" required
                               class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="sma_slow_period" class="block text-sm font-medium text-gray-700">Slow SMA Period:</label>
                        <input type="number" name="sma_slow_period" id="sma_slow_period" value="30" min="1" required
                               class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>
            </div>

            <div id="params-ema_crossover" class="strategy-params hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label for="ema_fast_period" class="block text-sm font-medium text-gray-700">Fast EMA Period:</label>
                        <input type="number" name="ema_fast_period" id="ema_fast_period" value="10" min="1" required
                               class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="ema_slow_period" class="block text-sm font-medium text-gray-700">Slow EMA Period:</label>
                        <input type="number" name="ema_slow_period" id="ema_slow_period" value="30" min="1" required
                               class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>
            </div>

            <div id="params-rsi" class="strategy-params hidden">
                <div class="form-group">
                    <label for="rsi_period" class="block text-sm font-medium text-gray-700">RSI Period:</label>
                    <input type="number" name="rsi_period" id="rsi_period" value="14" min="1" required
                           class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label for="oversold" class="block text-sm font-medium text-gray-700">RSI Oversold Threshold:</label>
                        <input type="number" name="oversold" id="oversold" value="30" min="0" max="100" required
                               class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="overbought" class="block text-sm font-medium text-gray-700">RSI Overbought Threshold:</label>
                        <input type="number" name="overbought" id="overbought" value="70" min="0" max="100" required
                               class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>
            </div>

            <div id="params-bollinger_bands" class="strategy-params hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label for="bb_period" class="block text-sm font-medium text-gray-700">Bollinger Bands Period:</label>
                        <input type="number" name="bb_period" id="bb_period" value="20" min="1" required
                               class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="devfactor" class="block text-sm font-medium text-gray-700">Standard Deviation Multiplier:</label>
                        <input type="number" step="0.1" name="devfactor" id="devfactor" value="2.0" min="0.1" required
                               class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>
            </div>

            <div id="params-macd" class="strategy-params hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label for="macd_fast_period" class="block text-sm font-medium text-gray-700">MACD Fast EMA Period:</label>
                        <input type="number" name="macd_fast_period" id="macd_fast_period" value="12" min="1" required
                               class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="macd_slow_period" class="block text-sm font-medium text-gray-700">MACD Slow EMA Period:</label>
                        <input type="number" name="macd_slow_period" id="macd_slow_period" value="26" min="1" required
                               class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="form-group">
                    <label for="macd_signal_period" class="block text-sm font-medium text-gray-700">MACD Signal Period:</label>
                    <input type="number" name="macd_signal_period" id="macd_signal_period" value="9" min="1" required
                           class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
            </div>

            <div id="params-breakout" class="strategy-params hidden">
                <div class="form-group">
                    <label for="lookback" class="block text-sm font-medium text-gray-700">Breakout Lookback Period:</label>
                    <input type="number" name="lookback" id="lookback" value="20" min="1" required
                           class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
            </div>

            <div class="form-group">
                <label for="risk_free_rate" class="block text-sm font-medium text-gray-700">Risk-Free Rate (%):</label>
                <input type="number" step="0.01" name="risk_free_rate" id="risk_free_rate" value="3.0" min="0" required
                       class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
            </div>

            <div class="flex justify-center mt-8">
                <button type="submit" class="submit-button">Run Backtest</button>
            </div>
        </form>

        {% if results %}
            <div class="results-section">
                {% if results.error %}
                    <div class="error-message">
                        <p class="font-bold">Error:</p>
                        <p>{{ results.message }}</p>
                    </div>
                {% else %}
                    <div class="success-message">
                        <p class="font-bold">Backtest Results ({{ results.strategy_name }}):</p>
                        <p>{{ results.message }}</p>
                    </div>
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Summary:</h3>
                        <p><strong>Initial Portfolio Value ({{ results.start_date }}):</strong> {{ results.initial_value }}</p>
                        <p><strong>Final Portfolio Value ({{ results.end_date }}):</strong> {{ results.final_value }}</p>
                        <p><strong>Profit/Loss:</strong> {{ results.profit }}</p>
                        <p><strong>Profit/Loss Percentage:</strong> {{ results.profit_percent }}</p>
                        {% if results.sma_fast_period %}
                            <p><strong>Fast SMA Period:</strong> {{ results.sma_fast_period }}</p>
                        {% endif %}
                        {% if results.sma_slow_period %}
                            <p><strong>Slow SMA Period:</strong> {{ results.sma_slow_period }}</p>
                        {% endif %}
                        {% if results.ema_fast_period %}
                            <p><strong>Fast EMA Period:</strong> {{ results.ema_fast_period }}</p>
                        {% endif %}
                        {% if results.ema_slow_period %}
                            <p><strong>Slow EMA Period:</strong> {{ results.ema_slow_period }}</p>
                        {% endif %}
                        {% if results.rsi_period %}
                            <p><strong>RSI Period:</strong> {{ results.rsi_period }}</p>
                        {% endif %}
                        {% if results.oversold %}
                            <p><strong>Oversold Threshold:</strong> {{ results.oversold }}</p>
                        {% endif %}
                        {% if results.overbought %}
                            <p><strong>Overbought Threshold:</strong> {{ results.overbought }}</p>
                        {% endif %}
                        {% if results.bb_period %}
                            <p><strong>Bollinger Bands Period:</strong> {{ results.bb_period }}</p>
                        {% endif %}
                        {% if results.devfactor %}
                            <p><strong>Standard Deviation Multiplier:</strong> {{ results.devfactor }}</p>
                        {% endif %}
                        {% if results.macd_fast_period %}
                            <p><strong>MACD Fast EMA Period:</strong> {{ results.macd_fast_period }}</p>
                        {% endif %}
                        {% if results.macd_slow_period %}
                            <p><strong>MACD Slow EMA Period:</strong> {{ results.macd_slow_period }}</p>
                        {% endif %}
                        {% if results.macd_signal_period %}
                            <p><strong>MACD Signal Period:</strong> {{ results.macd_signal_period }}</p>
                        {% endif %}
                        {% if results.lookback %}
                            <p><strong>Breakout Lookback Period:</strong> {{ results.lookback }}</p>
                        {% endif %}
                        <p><strong>Risk-Free Rate:</strong> {{ results.risk_free_rate }}</p>
                        <p><strong>Sharpe Ratio:</strong> {{ results.sharpe_ratio }}</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="equityChart"></canvas>
                    </div>
                    <script>
                        const ctx = document.getElementById('equityChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: {{ results.chart_data.labels | tojson }},
                                datasets: [
                                    {
                                        label: 'Portfolio Equity',
                                        data: {{ results.chart_data.equity | tojson }},
                                        borderColor: '#3b82f6',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        fill: false,
                                        tension: 0.1
                                    },
                                    {
                                        label: 'Buy Signals',
                                        data: {{ results.chart_data.buy_signals | tojson }},
                                        type: 'scatter',
                                        borderColor: '#16a34a',
                                        backgroundColor: '#16a34a',
                                        pointStyle: 'triangle',
                                        pointRadius: 8,
                                        showLine: false
                                    },
                                    {
                                        label: 'Sell Signals',
                                        data: {{ results.chart_data.sell_signals | tojson }},
                                        type: 'scatter',
                                        borderColor: '#dc2626',
                                        backgroundColor: '#dc2626',
                                        pointStyle: 'triangle',
                                        pointRadius: 8,
                                        showLine: false
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: {
                                        title: { display: true, text: 'Date' },
                                        ticks: { maxTicksLimit: 10 }
                                    },
                                    y: {
                                        title: { display: true, text: 'Portfolio Value ($)' },
                                        beginAtZero: false
                                    }
                                },
                                plugins: {
                                    legend: { display: true },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.parsed.y !== null) {
                                                    if (context.dataset.label.includes('Signals')) {
                                                        label += `$${context.parsed.y.toFixed(2)}`;
                                                    } else {
                                                        label += `$${context.parsed.y.toFixed(2)}`;
                                                    }
                                                }
                                                return label;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    </script>
                {% endif %}
            </div>
        {% endif %}
    </div>
    <script>
        function toggleParameters() {
            console.log('Toggling parameters for strategy:', document.getElementById('strategy').value);
            const strategy = document.getElementById('strategy').value;
            const paramDivs = document.querySelectorAll('.strategy-params');
            paramDivs.forEach(div => {
                div.classList.add('hidden');
                console.log('Hiding:', div.id);
            });
            const activeDiv = document.getElementById('params-' + strategy);
            if (activeDiv) {
                activeDiv.classList.remove('hidden');
                console.log('Showing:', activeDiv.id);
            } else {
                console.error('No params div found for strategy:', strategy);
            }
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing parameters');
            toggleParameters();
            const strategySelect = document.getElementById('strategy');
            if (strategySelect) {
                strategySelect.addEventListener('change', toggleParameters);
            } else {
                console.error('Strategy select element not found');
            }
        });
    </script>
</body>
</html>